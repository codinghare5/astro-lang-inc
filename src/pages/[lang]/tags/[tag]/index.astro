---
export const prerender = true

import DefaultPageLayout from '$/layouts/default.astro'
import PostPreviewList from '$/components/PostPreviewList.astro'
import { getCollection } from 'astro:content'

export async function getStaticPaths({ }) {
  const allPosts = await getCollection('blog')
  const allTags = new Set()
  allPosts.map(post => {
      post.data.tags && post.data.tags.map(tag => allTags.add(tag.toLowerCase()))
  })

  return Array.from(allTags).map((tag) => {
    const filteredPosts = allPosts.filter((post) => post.data.lang === post.slug.split('/')[0] && post.data.tags.includes(tag))
    const lang = filteredPosts[0].data.lang
    return {
      params: { lang, tag },
      props: {
          posts: filteredPosts
      }
    };
  });
}

const { posts } = Astro.props
const { lang, tag } = Astro.params
---

<DefaultPageLayout content={{ title: `Posts by Tag: ${tag}`, description: `all of the articles we have posted and linked so far under the tag: ${tag}` }}>
    <PostPreviewList posts={posts} />
</DefaultPageLayout>
