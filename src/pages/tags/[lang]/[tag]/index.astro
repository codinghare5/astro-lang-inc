---
export const prerender = true

import DefaultPageLayout from '$/layouts/default.astro'
import PostPreviewList from '$/components/PostPreviewList.astro'
import { getCollection } from 'astro:content'

export async function getStaticPaths() {
  const allPosts = await getCollection('blog')

  const paths = allPosts.map(page => {
		const [lang,] = page.slug.split('/');
		const posts = allPosts.filter((post) => post.data.lang === lang)
		const allTags = [...new Set([].concat.apply([], posts.map(post => post.data.tags)))]
    
		return Array.from(allTags).map((tag) => {
      const filteredPosts = posts.filter((post) => post.data.tags.includes(tag))
      return {
        params: { lang, tag },
        props: {
            posts: filteredPosts
        }
      };
    });
  })

  return paths.flat();
}

const { posts } = Astro.props
const { lang, tag } = Astro.params
---

<DefaultPageLayout content={{ title: `Posts by Tag: ${tag}`, description: `all of the articles we have posted and linked so far under the tag: ${tag}` }}>
    <PostPreviewList posts={posts} />
</DefaultPageLayout>
